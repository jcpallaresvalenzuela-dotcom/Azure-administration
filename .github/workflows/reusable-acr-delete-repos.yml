name: Reusable - Delete all repositories in ACR (Azure CLI)

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: If true, do not delete, only print actions
        required: false
        default: false
        type: boolean
  
  workflow_call:
    inputs:
      dry-run:
        description: If true, do not delete, only print actions
        required: false
        default: false
        type: boolean
    secrets:
      SERVICE_PRINCIPAL:
        required: true
        description: Azure credentials JSON created with --sdk-auth
      ACR_NAME:
        required: true
        description: ACR name (short, e.g. jcpallares)


jobs:
  delete-repos:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Login to Azure (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.SERVICE_PRINCIPAL }}

      - name: Login to ACR (data-plane)
        shell: bash
        env:
          ACR_NAME: ${{ secrets.ACR_NAME }}
        run: |
          set -euo pipefail
          az acr login -n "${ACR_NAME}" --expose-token --only-show-errors 1>/dev/null

      - name: Delete repositories in ACR
        shell: bash
        env:
          ACR_NAME: ${{ secrets.ACR_NAMEe }}
          DRY_RUN: ${{ inputs['dry-run'] }}
        run: |
          set -euo pipefail

          echo "Listing repositories in ACR: ${ACR_NAME}"

          # Listar una vez y mostrar; si no hay nada, salir
          REPO_COUNT=$(az acr repository list -n "${ACR_NAME}" -o tsv --only-show-errors | wc -l | tr -d ' ')
          if [[ "${REPO_COUNT}" == "0" ]]; then
            echo "No repositories found. Nothing to delete."
            exit 0
          fi

          echo "Found repositories:"
          az acr repository list -n "${ACR_NAME}" -o tsv --only-show-errors | sed 's/^/ - /'

          if [[ "${DRY_RUN}" == "true" ]]; then
            echo "DRY RUN enabled. Skipping deletions."
            exit 0
          fi

          # Procesar en streaming (portable a bash 3.x)
          az acr repository list -n "${ACR_NAME}" -o tsv --only-show-errors \
          | while IFS= read -r repo; do
              [[ -z "${repo}" ]] && continue
              echo "Deleting repository: ${repo}"
              az acr repository delete -n "${ACR_NAME}" --repository "${repo}" --yes --only-show-errors 1>/dev/null
              # opcional: espera entre borrados
              # sleep 15
            done

          echo "Done deleting repositories in ${ACR_NAME}."
        
